@ [toc](目录)

## 技术文档

我是大二机器人2202班叶康杰，在文档开始前我想先说下情况，因为很晚才知道招新截至是在30号(之前一直以为是嵌软文件里说的7号)加上我们最近正好之前接的外包项目的交付和技术文档催的比较急，所以我的**工程和文档都是在30号一天之内完成的**，再加上之前没咋用过按钮导致花了较多时间所以只是完成了90%左右的任务，最后的debug并没有完成，请大佬见谅，== 给个面试机会 ==(要不是我不知道markdown怎么发表情包现在肯定在这加上个磕头表情)

又及:由于时间紧迫，我用的是我最习惯的hal库进行开发，我没注意要求中对库是否有限定，如果有，麻烦网开一面(磕头*2)

### 任务一：

#### 基本原理，功能实现及源码分析：

灯：控制GPIO高低点平实现灯的亮灭

跑马灯：利用定时器定时中断更换标志+轮询的方式实现不同种等的状态

![image-20230930225158188](C:\Users\asus\AppData\Roaming\Typora\typora-user-images\image-20230930225158188.png)

![image-20230930225057894](C:\Users\asus\AppData\Roaming\Typora\typora-user-images\image-20230930225057894.png)

按钮控制：EXTI触发下降沿中断实现观测按键

![image-20230930225455197](C:\Users\asus\OneDrive\桌面\叶康杰-RM2024狼牙招新嵌软\image-20230930225455197.png)

其他：为稳定性等，为按钮和输出GPIO均做了上拉

#### 难点及总结：

无

#### 参考资料：

无



### 任务二：

#### 基本原理，功能实现及源码分析：

设备新上电后需要长摁设置系统当前时间：使用RTC保证掉电时钟继续走，写到后备区，长按后将后备区时间读出即可

![image-20230930225907687](C:\Users\asus\OneDrive\桌面\叶康杰-RM2024狼牙招新嵌软\image-20230930225907687.png)

按钮单击，双击和长按的识别：编写扫描函数，检测按下的时间分辨单击和长按，检测两次按下间隔分辨双击；将扫描函数装到定时器中断里

![image-20230930230340355](C:\Users\asus\OneDrive\桌面\叶康杰-RM2024狼牙招新嵌软\image-20230930230340355.png)

登记，打卡和查询：在串口中断处理函数中用标志位分出这三种情况

![image-20230930230529018](C:\Users\asus\OneDrive\桌面\叶康杰-RM2024狼牙招新嵌软\image-20230930230529018.png)

![image-20230930230559066](C:\Users\asus\OneDrive\桌面\叶康杰-RM2024狼牙招新嵌软\image-20230930230559066.png)

灯：同任务一(不过把反转电平指令从轮询放到定时器中断里了)

DMA接收：

在USART使用时用对应的中断函数（HAL_UARTEx_ReceiveToIdle_DMA）并在中断处理处理函数（HAL_UARTEx_RxEventCallback）处理即可

其他：

为了更好的可读性以及实现方便，自己定义了几个结构和枚举

#### 难点及总结：

***DMA***用了我在这个工程中20%的时间，主要是因为在固件更新前没有HAL_UARTEx_ReceiveToIdle_DMA这个用于接收不定长数据的函数，需要使用寄存器来使用，我查了资料写完之后发现评论区有人发了这个新函数，我听说它更简洁优雅就去查了相关资料，这东西用法很简单但是要注意在用之前要关掉串口DMA和中断，而所有的参考资料都说要关DMA并开启中断，后面我调试看寄存器对比之后发现应该把中断关掉，，马上就好了，不知道是不是最近固件库又更新了的原因；这样DMA甚至比中断的实现还要简单

***按键***我现在其实都没完全搞明白，csdn上大部分都不好用，其中绝大部分需要阻塞轮询查看按键状态，或是在中断中加延时函数；而且没有一个能完全不靠轮询的；于是我就想自己写一个，反正以后小项目里用按键的机会很多，早晚得写，我的基本思路其实是通过记下按键按下和释放时定时器的cnt值，进行一系列比较来得到是哪一种情况。面临的问题主要还是因为抖动等难以判断是否是第一次按下，我现在想应该也可以加个按按键间隔来解决，不过没写完，先写了个阉割版，缺点是不能区分三击和双击(虽然没要求)而且识别精度有点问题，还得后面再研究下

#### 参考资料：

https://blog.csdn.net/weixin_45908425/article/details/116764153?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522169607826416800184199402%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=169607826416800184199402&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-10-116764153-null-null.142^v94^chatsearchT3_1&utm_term=stm32%E6%8C%89%E9%94%AE%E9%95%BF%E6%8C%89%E7%9F%AD%E6%8C%89%E5%8F%8C%E5%87%BB&spm=1018.2226.3001.4187

之前RTC掉和DMA寄存器实现看了z小旋的原理解读和例程

加分项：大二任务1加分项；大二任务2加分项(用了DMA)

因为时间原因本工程和文档都有很多不足之处，工程的注释可能也不是很够，请谅解